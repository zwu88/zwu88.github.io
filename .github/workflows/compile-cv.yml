name: Auto-Update CV

on:
  push:
    branches: [ main ]
    paths:
      - '_config.yml'
      - '_data/publications.yml'
      - '_data/education.yml'
      - '_data/honors.yml'
      - '_data/service.yml'
      - 'index.md'
      - 'scripts/generate_cv.py'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-cv:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python for CV generation
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: pip install pyyaml html5lib
      
    - name: Generate CV data (Stage 1)
      run: |
        echo "ğŸ”§ Stage 1: Scraping data from website files..."
        python scripts/generate_cv.py --stage 1
        echo "âœ… Stage 1 complete: Integrated CV data saved"

    - name: Generate LaTeX CV (Stage 2)
      run: |
        echo "ğŸ”§ Stage 2: Generating LaTeX from integrated data..."
        python scripts/generate_cv.py --stage 2
        echo "âœ… Stage 2 complete: LaTeX CV generated"

    - name: Compile LaTeX to PDF
      uses: xu-cheng/latex-action@v3
      with:
        root_file: assets/files/cv.tex
        args: -pdf -file-line-error -halt-on-error -interaction=nonstopmode
        
    - name: Move PDF to correct location
      run: |
        mv cv.pdf assets/files/cv.pdf
        echo "âœ… PDF generated successfully"
        
    - name: Check if files changed
      id: check_changes
      run: |
        git diff --quiet _data/cv_integrated.yml assets/files/cv.tex assets/files/cv.pdf || echo "changes=true" >> $GITHUB_OUTPUT
        
    - name: Commit and push if changed
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add _data/cv_integrated.yml assets/files/cv.tex assets/files/cv.pdf
        git commit -m "ğŸ¤– Auto-update CV: LaTeX, PDF, and data for Jekyll [skip ci]" || exit 0
        git push
        
    - name: Trigger GitHub Pages rebuild
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "ğŸ”„ GitHub Pages will automatically rebuild with updated CV data"
        echo "ğŸŒ Jekyll will regenerate HTML CV from updated _data/cv_integrated.yml"
        
    - name: Summary
      run: |
        echo "ğŸ‰ CV auto-update complete!"
        echo ""
        echo "ğŸ“Š Updated files:"
        echo "  â€¢ _data/cv_integrated.yml (Jekyll data source)"
        echo "  â€¢ assets/files/cv.tex (LaTeX source)"  
        echo "  â€¢ assets/files/cv.pdf (PDF download)"
        echo ""
        echo "ğŸŒ CV webpage: https://zwu88.github.io/cv/"
        echo "   â””â”€ Auto-generated by Jekyll from cv_integrated.yml"
        echo ""
        echo "ğŸ“¥ Downloads available:"
        echo "   â€¢ PDF: https://zwu88.github.io/assets/files/cv.pdf"
        echo "   â€¢ LaTeX: https://zwu88.github.io/assets/files/cv.tex"
        echo ""
        ls -lh assets/files/cv.tex assets/files/cv.pdf || true

